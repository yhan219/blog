<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>redis 系列之——高可用（主从、哨兵、集群） - yhan219</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="yhan219的个人博客"><meta name="msapplication-TileImage" content="https://coding-net-production-static-ci.codehub.cn/a79d1f0e-bb39-4be8-afc5-99302615f944.jpg?imageMogr2/auto-orient/format/jpeg/cut/800x800x0x0"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="yhan219的个人博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="所谓的高可用，也叫 HA（High Availability），是分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计减少系统不能提供服务的时间。 如果在实际生产中，如果 redis 只部署一个节点，当机器故障时，整改服务都不能提供服务了。这就是我们常说的单点故障。 如果 redis 部署了多台，当一台或几台故障时，整个系统依然可以对外提供服务，这样就提高了服务的可用性。 今天我们就聊聊"><meta property="og:type" content="blog"><meta property="og:title" content="redis 系列之——高可用（主从、哨兵、集群）"><meta property="og:url" content="https://blog.yhan219.com/redis-ha/"><meta property="og:site_name" content="yhan219"><meta property="og:description" content="所谓的高可用，也叫 HA（High Availability），是分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计减少系统不能提供服务的时间。 如果在实际生产中，如果 redis 只部署一个节点，当机器故障时，整改服务都不能提供服务了。这就是我们常说的单点故障。 如果 redis 部署了多台，当一台或几台故障时，整个系统依然可以对外提供服务，这样就提高了服务的可用性。 今天我们就聊聊"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915150958396.png"><meta property="og:image" content="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915151107307.png"><meta property="og:image" content="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230905143020859.png"><meta property="og:image" content="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915152636599.png"><meta property="og:image" content="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915152859461.png"><meta property="og:image" content="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915153622434.png"><meta property="og:image" content="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230921105647611.png"><meta property="og:image" content="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915160639074.png"><meta property="article:published_time" content="2024-08-19T02:41:57.000Z"><meta property="article:modified_time" content="2024-08-19T02:41:57.000Z"><meta property="article:author" content="诸葛小猿"><meta property="article:tag" content="devops"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915150958396.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.yhan219.com/redis-ha/"},"headline":"yhan219","image":["https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915150958396.png","https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915151107307.png","https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230905143020859.png","https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915152636599.png","https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915152859461.png","https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915153622434.png","https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230921105647611.png","https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915160639074.png"],"datePublished":"2024-08-19T02:41:57.000Z","dateModified":"2024-08-19T02:41:57.000Z","author":{"@type":"Person","name":"诸葛小猿"},"description":"所谓的高可用，也叫 HA（High Availability），是分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计减少系统不能提供服务的时间。 如果在实际生产中，如果 redis 只部署一个节点，当机器故障时，整改服务都不能提供服务了。这就是我们常说的单点故障。 如果 redis 部署了多台，当一台或几台故障时，整个系统依然可以对外提供服务，这样就提高了服务的可用性。 今天我们就聊聊"}</script><link rel="canonical" href="https://blog.yhan219.com/redis-ha/"><link rel="icon" href="https://coding-net-production-static-ci.codehub.cn/a79d1f0e-bb39-4be8-afc5-99302615f944.jpg?imageMogr2/auto-orient/format/jpeg/cut/800x800x0x0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/qtcreator_dark.css"><link rel="stylesheet"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?16cea3704e5dd91460340a2925dca9e9";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://coding-net-production-static-ci.codehub.cn/a79d1f0e-bb39-4be8-afc5-99302615f944.jpg?imageMogr2/auto-orient/format/jpeg/cut/800x800x0x0" alt="yhan219" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="yhan219" href="https://github.com/yhan219"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 level is-mobile"><div class="level-left"><div class="article-date level-item"><i class="fa fa-calendar"></i><span>2024-08-19</span></div><span class="level-item"><time dateTime="2024-08-19T02:41:57.000Z" title="2024-08-19T02:41:57.000Z">2024-08-19</time>发表</span><span class="level-item"> <i class="fa fa-user"></i> 诸葛小猿 </span><span class="level-item"><i class="fa fa-folder"></i><a class="link-muted" href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></span><span class="level-item">18 分钟读完 (大约2704个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">redis 系列之——高可用（主从、哨兵、集群）</h1><div class="content"><p>所谓的高可用，也叫 HA（High Availability），是分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计减少系统不能提供服务的时间。</p>
<p>如果在实际生产中，如果 redis 只部署一个节点，当机器故障时，整改服务都不能提供服务了。这就是我们常说的单点故障。</p>
<p>如果 redis 部署了多台，当一台或几台故障时，整个系统依然可以对外提供服务，这样就提高了服务的可用性。</p>
<p>今天我们就聊聊 redis 高可用的三种模式：主从模式，哨兵模式，集群模式。<br><escape><a id="more"></a></escape></p>
<h2 id="安装gitea"><a href="#安装gitea" class="headerlink" title="安装gitea"></a>安装gitea</h2><blockquote>
<p>参考文档：<a target="_blank" rel="noopener" href="https://docs.gitea.com/zh-cn/installation/install-with-docker">https://docs.gitea.com/zh-cn/installation/install-with-docker</a></p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /usr/<span class="keyword">local</span></span><br><span class="line"><span class="keyword">mkdir</span> gitea</span><br><span class="line">vim docker-compose.yml</span><br></pre></td></tr></table></figure>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">networks:</span></span><br><span class="line"><span class="symbol">  gitea:</span></span><br><span class="line"><span class="symbol">    external:</span> false</span><br><span class="line"></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"><span class="symbol">  server:</span></span><br><span class="line"><span class="symbol">    image:</span> gitea/gitea:<span class="number">1.20</span><span class="number">.4</span></span><br><span class="line"><span class="symbol">    container_name:</span> gitea</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line">      - USER_UID=<span class="number">1000</span></span><br><span class="line">      - USER_GID=<span class="number">1000</span></span><br><span class="line"><span class="symbol">    restart:</span> always</span><br><span class="line"><span class="symbol">    networks:</span></span><br><span class="line">      - gitea</span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - ./gitea:/data</span><br><span class="line">      - <span class="meta-keyword">/etc/</span>timezone:<span class="meta-keyword">/etc/</span>timezone:ro</span><br><span class="line">      - <span class="meta-keyword">/etc/</span>localtime:<span class="meta-keyword">/etc/</span>localtime:ro</span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">      - <span class="string">&quot;222:22&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动gitea</span></span><br><span class="line"><span class="attribute">docker</span> compose up -d</span><br></pre></td></tr></table></figure>
<p>启用action</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim gitea/gitea/conf/app.ini</span><br><span class="line">------</span><br><span class="line">#末尾添加</span><br><span class="line"><span class="meta">[actions]</span></span><br><span class="line">ENABLED=true</span><br><span class="line">------</span><br><span class="line">## 重启gitea</span><br><span class="line">docker restart gitea</span><br></pre></td></tr></table></figure>
<p>访问<a target="_blank" rel="noopener" href="http://your-ip:3000/">http://your-ip:3000</a> ,配置管理员账号密码和其他相应内容，点击安装即可。安装完成后如下：</p>
<p><img src="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915150958396.png" alt="image-20230915150958396"></p>
<blockquote>
<p>建议将服务暴漏为https域名，更能节省时间。以下以<a target="_blank" rel="noopener" href="https://gitea.mydomain.com为例./">https://gitea.mydomain.com为例。</a></p>
</blockquote>
<h2 id="安装act-runner"><a href="#安装act-runner" class="headerlink" title="安装act runner"></a>安装act runner</h2><blockquote>
<p> 参考文档：<strong><a target="_blank" rel="noopener" href="https://docs.gitea.com/zh-cn/usage/actions/act-runner">https://docs.gitea.com/zh-cn/usage/actions/act-runner</a></strong></p>
</blockquote>
<h3 id="获取token"><a href="#获取token" class="headerlink" title="获取token"></a>获取token</h3><p>到管理后台-actions-Runner中，点击创建runner，复制token，如下</p>
<p><img src="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915151107307.png" alt="image-20230915151107307"></p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr"># 例如如下token</span></span><br><span class="line"><span class="attr">AaJkPUFeQs37</span>hpG<span class="name">m6</span>SHUIqHx<span class="number">3</span>Tw<span class="number">8</span>km<span class="name">m0</span>xX<span class="number">5</span>gJv<span class="number">6</span>f</span><br></pre></td></tr></table></figure>
<h3 id="注册runner"><a href="#注册runner" class="headerlink" title="注册runner"></a>注册runner</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> runner</span><br><span class="line"><span class="keyword">cd</span> runner</span><br><span class="line"><span class="keyword">vim</span> docker-compose.yml</span><br></pre></td></tr></table></figure>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">version</span>: <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attribute">services</span>:</span><br><span class="line">  <span class="attribute">runner</span>:</span><br><span class="line">    <span class="attribute">image</span>: gitea/<span class="attribute">act_runner</span>:nightly</span><br><span class="line">    <span class="attribute">container_name</span>: gitea_runner</span><br><span class="line">    <span class="attribute">restart</span>: always</span><br><span class="line">    <span class="attribute">environment</span>:</span><br><span class="line">      <span class="attribute">CONFIG_FILE</span>: /config.yaml</span><br><span class="line">      <span class="attribute">GITEA_INSTANCE_URL</span>: <span class="string">&quot;https://your-ip:3000&quot;</span></span><br><span class="line">      <span class="attribute">GITEA_RUNNER_REGISTRATION_TOKEN</span>: <span class="string">&quot;AaJkPUFeQs37hpGm6SHUIqHx3Tw8kmm0xX5gJv6f&quot;</span></span><br><span class="line">      <span class="attribute">GITEA_RUNNER_NAME</span>: <span class="string">&quot;my-runner&quot;</span></span><br><span class="line">      <span class="attribute">GITEA_RUNNER_LABELS</span>: <span class="string">&quot;$&#123;RUNNER_LABELS&#125;&quot;</span>#需要特殊环境部署的，可以修改该标签，或在web控制台修改</span><br><span class="line">    <span class="attribute">volumes</span>:</span><br><span class="line">      - ./config.<span class="attribute">yaml</span>:/config.yaml</span><br><span class="line">      - ./<span class="attribute">data</span>:/data</span><br><span class="line">      - /var/run/docker.<span class="attribute">sock</span>:/var/run/docker.sock</span><br><span class="line">      - /etc/<span class="attribute">timezone</span>:/etc/<span class="attribute">timezone</span>:ro</span><br><span class="line">      - /etc/<span class="attribute">localtime</span>:/etc/<span class="attribute">localtime</span>:ro</span><br><span class="line">    <span class="attribute">ports</span>:</span><br><span class="line">      - <span class="string">&quot;8088:8088&quot;</span></span><br></pre></td></tr></table></figure>
<p>为加快构建速度，一般来说我们需要允许缓存：创建config.yaml，允许缓存，请注意修改<code>your-ip</code>为runner所在服务器的内网ip。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="built_in">config</span>.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example configuration file, it&#x27;s safe to copy this as the default config file without any modification.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You don&#x27;t have to copy this file to your instance,</span></span><br><span class="line"><span class="comment"># just run `./act_runner generate-config &gt; config.yaml` to generate a config file.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="comment"># The level of logging, can be trace, debug, info, warn, error, fatal</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">info</span></span><br><span class="line"></span><br><span class="line"><span class="attr">runner:</span></span><br><span class="line">  <span class="comment"># Where to store the registration result.</span></span><br><span class="line">  <span class="attr">file:</span> <span class="string">.runner</span></span><br><span class="line">  <span class="comment"># Execute how many tasks concurrently at the same time.</span></span><br><span class="line">  <span class="attr">capacity:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># Extra environment variables to run jobs.</span></span><br><span class="line">  <span class="attr">envs:</span></span><br><span class="line">    <span class="attr">A_TEST_ENV_NAME_1:</span> <span class="string">a_test_env_value_1</span></span><br><span class="line">    <span class="attr">A_TEST_ENV_NAME_2:</span> <span class="string">a_test_env_value_2</span></span><br><span class="line">    <span class="attr">RUNNER_TOOL_CACHE:</span> <span class="string">/toolcache</span></span><br><span class="line">  <span class="comment"># Extra environment variables to run jobs from a file.</span></span><br><span class="line">  <span class="comment"># It will be ignored if it&#x27;s empty or the file doesn&#x27;t exist.</span></span><br><span class="line">  <span class="attr">env_file:</span> <span class="string">.env</span></span><br><span class="line">  <span class="comment"># The timeout for a job to be finished.</span></span><br><span class="line">  <span class="comment"># Please note that the Gitea instance also has a timeout (3h by default) for the job.</span></span><br><span class="line">  <span class="comment"># So the job could be stopped by the Gitea instance if it&#x27;s timeout is shorter than this.</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">3h</span></span><br><span class="line">  <span class="comment"># Whether skip verifying the TLS certificate of the Gitea instance.</span></span><br><span class="line">  <span class="attr">insecure:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># The timeout for fetching the job from the Gitea instance.</span></span><br><span class="line">  <span class="attr">fetch_timeout:</span> <span class="string">5s</span></span><br><span class="line">  <span class="comment"># The interval for fetching the job from the Gitea instance.</span></span><br><span class="line">  <span class="attr">fetch_interval:</span> <span class="string">2s</span></span><br><span class="line">  <span class="comment"># The labels of a runner are used to determine which jobs the runner can run, and how to run them.</span></span><br><span class="line">  <span class="comment"># Like: [&quot;macos-arm64:host&quot;, &quot;ubuntu-latest:docker://node:16-bullseye&quot;, &quot;ubuntu-22.04:docker://node:16-bullseye&quot;]</span></span><br><span class="line">  <span class="comment"># If it&#x27;s empty when registering, it will ask for inputting labels.</span></span><br><span class="line">  <span class="comment"># If it&#x27;s empty when execute `deamon`, will use labels in `.runner` file.</span></span><br><span class="line">  <span class="attr">labels:</span> []</span><br><span class="line"></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line">  <span class="comment"># Enable cache server to use actions/cache.</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># The directory to store the cache data.</span></span><br><span class="line">  <span class="comment"># If it&#x27;s empty, the cache data will be stored in $HOME/.cache/actcache.</span></span><br><span class="line">  <span class="attr">dir:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># The host of the cache server.</span></span><br><span class="line">  <span class="comment"># It&#x27;s not for the address to listen, but the address to connect from job containers.</span></span><br><span class="line">  <span class="comment"># So 0.0.0.0 is a bad choice, leave it empty to detect automatically.</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&quot;your-ip&quot;</span></span><br><span class="line">  <span class="comment"># The port of the cache server.</span></span><br><span class="line">  <span class="comment"># 0 means to use a random available port.</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8088</span></span><br><span class="line">  <span class="comment"># The external cache server URL. Valid only when enable is true.</span></span><br><span class="line">  <span class="comment"># If it&#x27;s specified, act_runner will use this URL as the ACTIONS_CACHE_URL rather than start a server by itself.</span></span><br><span class="line">  <span class="comment"># The URL should generally end with &quot;/&quot;.</span></span><br><span class="line">  <span class="attr">external_server:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">container:</span></span><br><span class="line">  <span class="comment"># Specifies the network to which the container will connect.</span></span><br><span class="line">  <span class="comment"># Could be host, bridge or the name of a custom network.</span></span><br><span class="line">  <span class="comment"># If it&#x27;s empty, act_runner will create a network automatically.</span></span><br><span class="line">  <span class="attr">network:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># Whether to use privileged mode or not when launching task containers (privileged mode is required for Docker-in-Docker).</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># And other options to be used when the container is started (eg, --add-host=my.gitea.url:host-gateway).</span></span><br><span class="line">  <span class="attr">options:</span></span><br><span class="line">  <span class="comment"># The parent directory of a job&#x27;s working directory.</span></span><br><span class="line">  <span class="comment"># If it&#x27;s empty, /workspace will be used.</span></span><br><span class="line">  <span class="attr">workdir_parent:</span></span><br><span class="line">  <span class="comment"># Volumes (including bind mounts) can be mounted to containers. Glob syntax is supported, see https://github.com/gobwas/glob</span></span><br><span class="line">  <span class="comment"># You can specify multiple volumes. If the sequence is empty, no volumes can be mounted.</span></span><br><span class="line">  <span class="comment"># For example, if you only allow containers to mount the `data` volume and all the json files in `/src`, you should change the config to:</span></span><br><span class="line">    <span class="comment"># valid_volumes:</span></span><br><span class="line">  <span class="comment">#   - data</span></span><br><span class="line">  <span class="comment">#   - /src/*.json</span></span><br><span class="line">  <span class="comment"># If you want to allow any volume, please use the following configuration:</span></span><br><span class="line">  <span class="comment"># valid_volumes:</span></span><br><span class="line">  <span class="comment">#   - &#x27;**&#x27;</span></span><br><span class="line">  <span class="attr">valid_volumes:</span> []</span><br><span class="line">  <span class="comment"># overrides the docker client host with the specified one.</span></span><br><span class="line">  <span class="comment"># If it&#x27;s empty, act_runner will find an available docker host automatically.</span></span><br><span class="line">  <span class="comment"># If it&#x27;s &quot;-&quot;, act_runner will find an available docker host automatically, but the docker host won&#x27;t be mounted to the job containers and service containers.</span></span><br><span class="line">  <span class="comment"># If it&#x27;s not empty or &quot;-&quot;, the specified docker host will be used. An error will be returned if it doesn&#x27;t work.</span></span><br><span class="line">  <span class="attr">docker_host:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># Pull docker image(s) even if already present</span></span><br><span class="line">  <span class="attr">force_pull:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">host:</span></span><br><span class="line">  <span class="comment"># The parent directory of a job&#x27;s working directory.</span></span><br><span class="line">  <span class="comment"># If it&#x27;s empty, $HOME/.cache/act/ will be used.</span></span><br><span class="line">  <span class="attr">workdir_parent:</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker compose up -d</span></span><br></pre></td></tr></table></figure>
<p>重新刷新页面，可看到新的runner</p>
<p><img src="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230905143020859.png" alt="runner"></p>
<h2 id="安装k3s"><a href="#安装k3s" class="headerlink" title="安装k3s"></a>安装k3s</h2><blockquote>
<p>参考文档<a target="_blank" rel="noopener" href="https://docs.k3s.io/zh/quick-start">https://docs.k3s.io/zh/quick-start</a></p>
</blockquote>
<p>在需要部署应用的服务器(例如192.168.0.100)上安装K3s,安装命令</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL http<span class="variable">s:</span>//rancher-mirror.rancher.<span class="keyword">cn</span>/k3s/k3s-install.<span class="keyword">sh</span> | INSTALL_K3S_MIRROR=<span class="keyword">cn</span> <span class="keyword">sh</span> -</span><br></pre></td></tr></table></figure>
<p><strong>如果暴漏为https域名，可以省略以下步骤</strong></p>
<h2 id="私有仓库镜像配置"><a href="#私有仓库镜像配置" class="headerlink" title="私有仓库镜像配置"></a>私有仓库镜像配置</h2><blockquote>
<p>如果是配置了https域名的可以忽略本步</p>
</blockquote>
<p>docker允许访问gitea仓库</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/etc/</span>docker/daemon.json </span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;log-opts&quot;</span>: &#123;<span class="attr">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span>, <span class="attr">&quot;max-file&quot;</span>: <span class="string">&quot;100&quot;</span>&#125;,</span><br><span class="line">  <span class="attr">&quot;insecure-registries&quot;</span>: [</span><br><span class="line">   <span class="string">&quot;your-ip:3000&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>k3s允许访问gitea</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/etc/</span>rancher<span class="regexp">/k3s/</span>registries.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mirrors:</span></span><br><span class="line">  <span class="attr">gitea.mydomain.com:</span></span><br><span class="line">    <span class="attr">endpoint:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;http://your-ip:3000&quot;</span></span><br><span class="line"><span class="attr">configs:</span></span><br><span class="line">  <span class="attr">&quot;your-ip:3000&quot;:</span></span><br><span class="line">    <span class="attr">auth:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">your-gitea-name</span> <span class="comment"># this is the registry username</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">your-gitea-password</span> <span class="comment"># this is the registry password</span></span><br></pre></td></tr></table></figure>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">restart</span> docker</span><br><span class="line">systemctl <span class="built_in">restart</span> k3s</span><br></pre></td></tr></table></figure>
<h2 id="持续集成"><a href="#持续集成" class="headerlink" title="持续集成"></a>持续集成</h2><p>以下步骤将会以<a target="_blank" rel="noopener" href="https://gitee.com/dromara/RuoYi-Vue-Plus">ruoyi-vue-plus</a>为例。</p>
<h3 id="启用action"><a href="#启用action" class="headerlink" title="启用action"></a>启用action</h3><p>点击右上角<code>+</code>-<code>迁移外部仓库</code>将ruoyi-vue-plus仓库迁移到本地gitea中。待迁移完成后，点击<code>项目设置-仓库-启用actions</code>,点击<code>更新仓库设置</code>按钮，开启项目action.</p>
<p><img src="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915152636599.png" alt="image-20230915152636599"></p>
<p><img src="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915152859461.png" alt="image-20230915152859461"></p>
<h3 id="获取gitea部署token"><a href="#获取gitea部署token" class="headerlink" title="获取gitea部署token"></a>获取gitea部署token</h3><p>在<code>个人信息及配置-应用</code>中生成一个token，注意权限选择<code>repository</code>和<code>user</code>都是<code>read</code>，其他不选。</p>
<p>请注意令牌只会显示一次，复制保管好。</p>
<p><img src="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915153622434.png" alt="image-20230915153622434"></p>
<h3 id="添加CI文件"><a href="#添加CI文件" class="headerlink" title="添加CI文件"></a>添加CI文件</h3><p>以最新分支<strong>5.X</strong>为例，切换到5.X分支，在项目中添加<code>.gitea/workflows/main.yml</code>文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Ruoyi</span> <span class="string">Vue</span> <span class="string">Plus</span></span><br><span class="line"><span class="attr">run-name:</span> <span class="string">CI/CD</span> <span class="string">runner</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="comment"># Sequence of patterns matched against refs/heads</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5.</span><span class="string">X</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">ci-and-cd:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">container:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">catthehacker/ubuntu:act-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="comment"># cache bug https://gitea.com/gitea/act_runner/issues/70</span></span><br><span class="line">      <span class="attr">RUNNER_TOOL_CACHE:</span> <span class="string">/toolcache</span></span><br><span class="line">      <span class="attr">REGISTRY:</span> <span class="string">gitea.mydomain.com</span></span><br><span class="line">      <span class="attr">APP_NAME:</span> <span class="string">ruoyi-admin</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">checkout</span> <span class="string">from</span> <span class="string">git</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Java</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">graalvm/setup-graalvm@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">java-version:</span> <span class="string">&#x27;17.0.7&#x27;</span></span><br><span class="line">          <span class="attr">distribution:</span> <span class="string">&#x27;graalvm&#x27;</span></span><br><span class="line">          <span class="attr">cache:</span> <span class="string">&#x27;maven&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">with</span> <span class="string">Maven</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">mvn</span> <span class="string">package</span> <span class="string">-DskipTests</span> <span class="string">-Pprod</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Extract</span> <span class="string">metadata</span> <span class="string">(tags,</span> <span class="string">labels)</span> <span class="string">for</span> <span class="string">Docker</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">meta</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/metadata-action@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">images:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.REGISTRY</span> <span class="string">&#125;&#125;/devops/$&#123;&#123;</span> <span class="string">env.APP_NAME</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Login</span> <span class="string">to</span> <span class="string">Docker</span> <span class="string">Hub</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/login-action@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">registry:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.REGISTRY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DOCKERHUB_USERNAME</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DOCKERHUB_PASSWORD</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/build-push-action@master</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">context:</span> <span class="string">./ruoyi-admin</span></span><br><span class="line">          <span class="attr">push:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event_name</span> <span class="type">!=</span> <span class="string">&#x27;pull_request&#x27;</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">tags:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.meta.outputs.tags</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">labels:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.meta.outputs.labels</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s</span> <span class="string">Check</span> <span class="string">and</span> <span class="string">Apply</span> <span class="string">New</span> <span class="string">Deployment</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions-hub/kubectl@master</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">KUBE_CONFIG:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.KUBE_CONFIG</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">args:</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">http://$&#123;&#123;</span> <span class="string">secrets.DEVOPS_GITEA_TOKEN</span> <span class="string">&#125;&#125;@$&#123;&#123;</span> <span class="string">env.REGISTRY</span> <span class="string">&#125;&#125;/devops/ruoyi-vue-plus/raw/branch/master/.deploy/deployment.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s</span> <span class="string">Update</span> <span class="string">Deployment</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions-hub/kubectl@master</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">KUBE_CONFIG:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.KUBE_CONFIG</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">args:</span> <span class="string">rollout</span> <span class="string">restart</span> <span class="string">deployment</span> <span class="string">$&#123;&#123;</span> <span class="string">env.APP_NAME</span> <span class="string">&#125;&#125;-$&#123;&#123;</span> <span class="string">gitea.ref_name</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="设置action密钥"><a href="#设置action密钥" class="headerlink" title="设置action密钥"></a>设置action密钥</h3><p>可以在个人中心，action中设置全局的，也可以在仓库中设置对应仓库的。</p>
<h4 id="添加docker-hub配置"><a href="#添加docker-hub配置" class="headerlink" title="添加docker hub配置"></a>添加docker hub配置</h4><p>在actions中，添加密钥，名称为<code>DOCKERHUB_USERNAME</code>和<code>DOCKERHUB_PASSWORD</code>，分别对应你的gitea账号和密码。添加<code>DEVOPS_GITEA_TOKEN</code>，即上一步得到的token。</p>
<h4 id="添加kube-config配置"><a href="#添加kube-config配置" class="headerlink" title="添加kube-config配置"></a>添加kube-config配置</h4><p>获取kube-config，默认放在<code>/etc/rancher/k3s/k3s.yaml</code>，复制内容，并修改ip为192.168.0.100，</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cp</span> /etc/rancher/k<span class="number">3</span>s/k<span class="number">3</span>s.yaml myk<span class="number">3</span>s.yaml</span><br><span class="line"><span class="attribute">vim</span> myk<span class="number">3</span>s.yaml</span><br><span class="line"><span class="comment"># 修改 server: https://127.0.0.1:6443 为  server: https://192.168.0.100:6443</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取KUBE_CONFIG</span></span><br><span class="line"><span class="attribute">cat</span> myk<span class="number">3</span>s.yaml | base<span class="number">64</span></span><br></pre></td></tr></table></figure>
<p>添加acitons密钥<code>KUBE_CONFIG</code>,值为上面输出的Base64</p>
<p><img src="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230921105647611.png" alt="image-20230921105647611"></p>
<h3 id="创建k8s-secret"><a href="#创建k8s-secret" class="headerlink" title="创建k8s secret"></a>创建k8s secret</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create<span class="built_in"> secret </span>docker-registry dockerhub-id <span class="attribute">--docker-server</span>=&lt;your-registry-server&gt; <span class="attribute">--docker-username</span>=&lt;your-name&gt; <span class="attribute">--docker-password</span>=&lt;your-pword&gt; <span class="attribute">--docker-email</span>=&lt;your-email&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="创建deployment"><a href="#创建deployment" class="headerlink" title="创建deployment"></a>创建deployment</h3><p>在.deploy目录下创建文件deployment.yml文件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">## k8s默认是访问不了外部服务的，需要代理,以mysql和redis为例，代理myservice名称到192.168.0.100，配置文件中对应的ip修改为myservice</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myservice</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myservice</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ruoyi-admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">ruoyi-admin</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">ruoyi-admin</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">gitea.mydomain.com/devops/ruoyi-admin:5.X</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">ruoyi-admin</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dockerhub-id</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ruoyi-admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Local</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30088</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">ruoyi-admin</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="推送并部署"><a href="#推送并部署" class="headerlink" title="推送并部署"></a>推送并部署</h3><p>提交代码，查看actions是否成功。运行成功后，访问<a target="_blank" rel="noopener" href="http://192.168.0.100:30088/">http://192.168.0.100:30088</a> 即可访问成功。</p>
<p><img src="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/image-20230915160639074.png" alt="image-20230915160639074"></p>
<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><h3 id="Q-actions中的Set-up-job慢，github访问超时"><a href="#Q-actions中的Set-up-job慢，github访问超时" class="headerlink" title="Q:actions中的Set up job慢，github访问超时"></a>Q:actions中的Set up job慢，github访问超时</h3><p>A:将github action仓库导入到本地gitea，修改ci文件为本地url，例如checkout，将 <a target="_blank" rel="noopener" href="https://github.com/actions/checkout.git">https://github.com/actions/checkout.git</a> 同步到本地，修改ci为</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">steps</span>:</span><br><span class="line">  - <span class="attribute">name</span>: checkout from git</span><br><span class="line">    <span class="attribute">uses</span>: <span class="attribute">https</span>:<span class="comment">//gitea.mydomain.com/devops/checkout@v3</span></span><br></pre></td></tr></table></figure>
<p>其他同理。</p>
<h3 id="Q：我需要部署的服务器是私有的，需要VPN才能访问，怎么办？"><a href="#Q：我需要部署的服务器是私有的，需要VPN才能访问，怎么办？" class="headerlink" title="Q：我需要部署的服务器是私有的，需要VPN才能访问，怎么办？"></a>Q：我需要部署的服务器是私有的，需要VPN才能访问，怎么办？</h3><p>A：如果该私有服务器能访问到gitea，只需要在该私有服务器上部署一个runner，修改该runner的<code>GITEA_RUNNER_LABELS</code>标签，例如<code>GITEA_RUNNER_LABELS: test-runner</code>然后修改ci文件，指定cd步骤为test-runner即可。</p>
<p>ci:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Ruoyi</span> <span class="string">Vue</span> <span class="string">Plus</span></span><br><span class="line"><span class="attr">run-name:</span> <span class="string">CI/CD</span> <span class="string">runner</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="comment"># Sequence of patterns matched against refs/heads</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5.</span><span class="string">X</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">ci:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">container:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">catthehacker/ubuntu:act-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="comment"># cache bug https://gitea.com/gitea/act_runner/issues/70</span></span><br><span class="line">      <span class="attr">RUNNER_TOOL_CACHE:</span> <span class="string">/toolcache</span></span><br><span class="line">      <span class="attr">REGISTRY:</span> <span class="string">gitea.mydomain.com</span></span><br><span class="line">      <span class="attr">APP_NAME:</span> <span class="string">ruoyi-admin</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">checkout</span> <span class="string">from</span> <span class="string">git</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">同上，将Deploy</span> <span class="string">to</span> <span class="string">k8s步骤移到后面</span></span><br><span class="line">  <span class="attr">cd:</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">ci</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">test-runner</span> <span class="comment"># 指定runner</span></span><br><span class="line">    <span class="attr">container:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">catthehacker/ubuntu:act-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="comment"># cache bug https://gitea.com/gitea/act_runner/issues/70</span></span><br><span class="line">      <span class="attr">RUNNER_TOOL_CACHE:</span> <span class="string">/toolcache</span></span><br><span class="line">      <span class="attr">REGISTRY:</span> <span class="string">gitea.mydomain.com</span></span><br><span class="line">      <span class="attr">APP_NAME:</span> <span class="string">ruoyi-admin</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s</span> <span class="string">Check</span> <span class="string">and</span> <span class="string">Apply</span> <span class="string">New</span> <span class="string">Deployment</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions-hub/kubectl@master</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">KUBE_CONFIG:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.KUBE_CONFIG</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">args:</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">http://$&#123;&#123;</span> <span class="string">secrets.DEVOPS_GITEA_TOKEN</span> <span class="string">&#125;&#125;@$&#123;&#123;</span> <span class="string">env.REGISTRY</span> <span class="string">&#125;&#125;/devops/ruoyi-vue-plus/raw/branch/master/.deploy/deployment.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s</span> <span class="string">Update</span> <span class="string">Deployment</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions-hub/kubectl@master</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">KUBE_CONFIG:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.KUBE_CONFIG</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">args:</span> <span class="string">rollout</span> <span class="string">restart</span> <span class="string">deployment</span> <span class="string">$&#123;&#123;</span> <span class="string">env.APP_NAME</span> <span class="string">&#125;&#125;-$&#123;&#123;</span> <span class="string">gitea.ref_name</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</div><div class="article-licensing box"><div class="licensing-title"><p>redis 系列之——高可用（主从、哨兵、集群）</p><p><a target="_blank" rel="noopener" href="https://xie.infoq.cn/article/6c3500c66c3cdee3d72b88780">https://xie.infoq.cn/article/6c3500c66c3cdee3d72b88780</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>诸葛小猿</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-08-19</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-08-19</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags"><i class="fa fa-tag"> </i><a class="link-muted mr-2" rel="tag" href="/tags/devops/">devops</a></div></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/UMqd62.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://raw.githubusercontent.com/yhan219/blog-image/master/yhan/RpRzj9.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/nginx-config/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">nginx配置</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/nginx-rate-limit/"><span class="level-item">Nginx配置限流，技能拉满！</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://coding-net-production-static-ci.codehub.cn/a79d1f0e-bb39-4be8-afc5-99302615f944.jpg?imageMogr2/auto-orient/format/jpeg/cut/800x800x0x0" alt="yhan219"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">yhan219</p><p class="is-size-6 is-block">java web</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>云南, 中国</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">50</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">62</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/yhan219" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#安装gitea"><span class="level-left"><span class="level-item">1</span><span class="level-item">安装gitea</span></span></a></li><li><a class="level is-mobile" href="#安装act-runner"><span class="level-left"><span class="level-item">2</span><span class="level-item">安装act runner</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#获取token"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">获取token</span></span></a></li><li><a class="level is-mobile" href="#注册runner"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">注册runner</span></span></a></li></ul></li><li><a class="level is-mobile" href="#安装k3s"><span class="level-left"><span class="level-item">3</span><span class="level-item">安装k3s</span></span></a></li><li><a class="level is-mobile" href="#私有仓库镜像配置"><span class="level-left"><span class="level-item">4</span><span class="level-item">私有仓库镜像配置</span></span></a></li><li><a class="level is-mobile" href="#持续集成"><span class="level-left"><span class="level-item">5</span><span class="level-item">持续集成</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#启用action"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">启用action</span></span></a></li><li><a class="level is-mobile" href="#获取gitea部署token"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">获取gitea部署token</span></span></a></li><li><a class="level is-mobile" href="#添加CI文件"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">添加CI文件</span></span></a></li><li><a class="level is-mobile" href="#设置action密钥"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">设置action密钥</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#添加docker-hub配置"><span class="level-left"><span class="level-item">5.4.1</span><span class="level-item">添加docker hub配置</span></span></a></li><li><a class="level is-mobile" href="#添加kube-config配置"><span class="level-left"><span class="level-item">5.4.2</span><span class="level-item">添加kube-config配置</span></span></a></li></ul></li><li><a class="level is-mobile" href="#创建k8s-secret"><span class="level-left"><span class="level-item">5.5</span><span class="level-item">创建k8s secret</span></span></a></li><li><a class="level is-mobile" href="#创建deployment"><span class="level-left"><span class="level-item">5.6</span><span class="level-item">创建deployment</span></span></a></li><li><a class="level is-mobile" href="#推送并部署"><span class="level-left"><span class="level-item">5.7</span><span class="level-item">推送并部署</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Q-amp-A"><span class="level-left"><span class="level-item">6</span><span class="level-item">Q&amp;A</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Q-actions中的Set-up-job慢，github访问超时"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">Q:actions中的Set up job慢，github访问超时</span></span></a></li><li><a class="level is-mobile" href="#Q：我需要部署的服务器是私有的，需要VPN才能访问，怎么办？"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">Q：我需要部署的服务器是私有的，需要VPN才能访问，怎么办？</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"><span class="level-start"><span class="level-item">中间件</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">学习</span></span><span class="level-end"><span class="level-item tag">24</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">工具</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-30T01:59:21.000Z">2024-12-30</time></p><p class="title"><a href="/nginx-config/">nginx配置</a></p><p class="categories"><a href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-19T02:41:57.000Z">2024-08-19</time></p><p class="title"><a href="/redis-ha/">redis 系列之——高可用（主从、哨兵、集群）</a></p><p class="categories"><a href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-02T04:14:13.000Z">2024-01-02</time></p><p class="title"><a href="/nginx-rate-limit/">Nginx配置限流，技能拉满！</a></p><p class="categories"><a href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-12-18T12:54:32.000Z">2023-12-18</time></p><p class="title"><a href="/k3s-ali-cert/">K3s/K8s实现阿里云https自动签发和续签</a></p><p class="categories"><a href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-09-15T06:41:57.000Z">2023-09-15</time></p><p class="title"><a href="/gitea-k3s-devops/">基于gitea+K3s实现DevOps/CI/CD</a></p><p class="categories"><a href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/08/"><span class="level-start"><span class="level-item">八月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/12/"><span class="level-start"><span class="level-item">十二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/09/"><span class="level-start"><span class="level-item">九月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/12/"><span class="level-start"><span class="level-item">十二月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/11/"><span class="level-start"><span class="level-item">十一月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">十二月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/DateGrip/"><span class="tag">DateGrip</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Idea/"><span class="tag">Idea</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/IntelliJ-IDEA/"><span class="tag">IntelliJ IDEA</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jetbrains/"><span class="tag">Jetbrains</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VPN/"><span class="tag">VPN</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/acme-sh/"><span class="tag">acme.sh</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/alfred/"><span class="tag">alfred</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/alpine/"><span class="tag">alpine</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/arthas/"><span class="tag">arthas</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bash/"><span class="tag">bash</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/centos/"><span class="tag">centos</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/devops/"><span class="tag">devops</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker-compose/"><span class="tag">docker compose</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gitea/"><span class="tag">gitea</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/http/"><span class="tag">http</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/https/"><span class="tag">https</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/idea/"><span class="tag">idea</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">java</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/navicat/"><span class="tag">navicat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rabbitmq/"><span class="tag">rabbitmq</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sdkman/"><span class="tag">sdkman</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/seaweedfs/"><span class="tag">seaweedfs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/show-hosts/"><span class="tag">show hosts</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring-boot/"><span class="tag">spring boot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">ssh</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systemctl/"><span class="tag">systemctl</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/systemd/"><span class="tag">systemd</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vpncmd/"><span class="tag">vpncmd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vps/"><span class="tag">vps</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/windows/"><span class="tag">windows</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/workflow/"><span class="tag">workflow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xxl-job/"><span class="tag">xxl-job</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zookeeper/"><span class="tag">zookeeper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"><span class="tag">中间件</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%91%E7%9B%98/"><span class="tag">云盘</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%85%8D%E8%B4%B9%E8%AF%81%E4%B9%A6/"><span class="tag">免费证书</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/"><span class="tag">内网穿透</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"><span class="tag">分布式</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"><span class="tag">分布式锁</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%91%BD%E4%BB%A4/"><span class="tag">命令</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%91%BD%E4%BB%A4%E8%A1%8C/"><span class="tag">命令行</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B0%8F%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8/"><span class="tag">小文件服务器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="tag">数据库</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%A5%E5%BF%97/"><span class="tag">日志</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%B6%E5%8C%BA/"><span class="tag">时区</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%97%B6%E9%97%B4/"><span class="tag">时间</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"><span class="tag">服务器</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"><span class="tag">消息队列</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%BF%80%E6%B4%BB/"><span class="tag">激活</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%B4%A2%E5%BC%95/"><span class="tag">索引</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%93%E5%AD%98/"><span class="tag">缓存</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%90%E7%BB%B4/"><span class="tag">运维</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%94%81/"><span class="tag">锁</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"><span class="tag">问题排查</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%99%90%E6%B5%81/"><span class="tag">限流</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://coding-net-production-static-ci.codehub.cn/a79d1f0e-bb39-4be8-afc5-99302615f944.jpg?imageMogr2/auto-orient/format/jpeg/cut/800x800x0x0" alt="yhan219" height="28"></a><p class="is-size-7"><span>&copy; 2018 - 2024 诸葛小猿</span>  版权所有<br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>